# V8 如何执行一段JS代码？
V8出现之前，所有的JS虚拟机所采用的都是**解释执行**的方式，这就是JS执行速度过慢的一个主要原因。
V8 引擎引入**即时编译（JIT）**的双轮驱动的设计，这样一种权衡策略，混合了**编译执行**和**解释执行**两种手段，极大地提升了JS的执行速度。

而且V8也早于其他虚拟机引入了**惰性编译、内联缓存、隐藏类**等机制，对于JS代码的编译执行效率进一步优化。
## V8 执行JS代码的主要流程
1. 初始化基础环境
2. 解析源码生成AST和作用域
3. 依赖AST和作用域生成字节码
4. 解释执行字节码
5. 监听热点代码
6. 优化热点代码为二进制的机器代码
7. 反优化生成的机器代码

※ 了解几个名词：

- 隐藏类：用来将JS中动态类型转为静态类型。可以消除动态类型的语言执行速度过慢的问题。
- 惰性解析：目的是为了**加速代码的启动速度**。
- V8事件循环系统：与JS中的异步编程特性密切相关。JS是单线程的，JS代码都是在一个线程上执行。如果同一时间发送了多个JS执行的请求，就需要排队，即进行异步编程。V8事件循环系统会调度这些排队任务，保证JS代码被V8有序执行，因此，事件循环系统就是V8的心脏，驱动V8的持续工作。
- 垃圾回收机制：自动垃圾回收是一种在堆内存中找出哪些对象在被使用，还有哪些对象没被使用，并且将后者删掉的机制。所谓使用中的对象（已引用对象），是指程序中有指针指向的对象；而未使用中的对象（未引用对象），则没有被任何指针给指向，因此占用的内存也可以被回收。JS是一种自动垃圾回收的语言。

# JS 与 V8
## 一等公民
**一等公民**可以作为函数参数，可以作为函数返回值，也可以赋值给变量。
*如果某个编程语言的函数，可以合这个语言的数据类型做一样的事情，我们就把这个语言中的函数称为一等公民。*
🌰栗子：
字符串在几乎所有编程语言中都是一等公民，字符串可以作为函数参数，字符串可以作为函数返回值，字符串也可以赋值给变量。对于各种编程语言来说，函数就不一定是一等公民了，比如java8之前的版本。
对于JS来说，函数可以赋值给变量，也可以作为函数参数，还可以作为函数返回值，因此JS中函数是一等公民。
## 动态作用域和静态作用域
- 作用域：作用域是一套规则，这套规则用来管理引擎如何在当前作用域以及嵌套的子作用域中根据标识名称进行变量查找。
- 静态作用域：又称词法作用域，函数的作用域在函数定义时就决定了，通俗点就是你在写代码的时候将变量和块作用域写在哪里决定了。
- 动态作用域：函数的作用域在函数调用时才决定的。

JS采用的是静态作用域，函数定义的位置就决定了函数的作用域。

## 闭包的三个基本特性
- JS语言允许在函数内部定义新的函数
- 可以在内部函数中访问父函数中定义的变量
- 因为JS中的函数是一等公民，所以函数可以作为另一个函数的返回值。

## 惰性解析
> 惰性解析是指解析器在解析的过程中，如果遇到函数声明，那么会跳过函数内部的代码，并不会为其生成AST和字节码，而仅仅生成顶层代码的AST和字节码。

在编译JS代码过程中，V8并不会一次将所有的JS解析为中间代码，主要是基于以下两点：

1. 如果一次解析和编译所有的JS代码，过多的代码会增加编译时间，严重影响到首次执行JS代码的速度，让用户感觉到卡顿。因为有时一个页面的JS代码很大，如果要将所有的代码一次性解析编译完成，那么会大大增加用户的等待时间；
2. 解析完成的字节码和编译后的机器代码都会存放在内存中，如果一次性解析和编译所有JS代码，那么这些中间代码和机器代码将会一直占用内存。

基于以上原因，所有主流的JS虚拟机都实现了惰性解析。

## 预解析器

V8引入预解析器，当解析顶层代码时，遇到了一个函数，那么预解析器不会跳过该函数，而是对该函数做一次快速的预解析。

1. 判断当前函数是否存在一些语法上的错误，发现了语法错误，那么就会向V8抛出错误；
2. 检查函数是否存在一些语法上的错误，如果引用了外部的变量，预解析器会将栈中的变量复制到堆中，在下次执行到该函数的时候，直接使用堆中的引用，这样就解决了闭包所带来的问题。

## V8 内部如何存储对象：快属性和满属性
